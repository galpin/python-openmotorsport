<html>
<head>
<title>openmotorsport.openmotorsport</title>
</head>
<body>
openmotorsport.openmotorsport
<style>
.coverage pre {float: left; margin: 0px 1em; border: none;
               padding: 0px; }
.num pre { margin: 0px }
.nocov, .nocov pre {background-color: #faa}
.cov, .cov pre {background-color: #cfc}
div.coverage div { clear: both; height: 1.1em}
</style>
<div class="stats">
Covered: 495 lines<br/>
Missed: 0 lines<br/>
Skipped 159 lines<br/>
Percent: 100 %<br/>

</div>
<div class="coverage">
<div class="skip"><span class="num"><pre>  1</pre></span><pre>#!/usr/bin/python2.6</pre></div>
<div class="skip"><span class="num"><pre>  2</pre></span><pre>#</pre></div>
<div class="skip"><span class="num"><pre>  3</pre></span><pre># A library that provides a python interface the OpenMotorsport format.</pre></div>
<div class="skip"><span class="num"><pre>  4</pre></span><pre>#</pre></div>
<div class="skip"><span class="num"><pre>  5</pre></span><pre># Author: Martin Galpin (m@66laps.com)</pre></div>
<div class="skip"><span class="num"><pre>  6</pre></span><pre>#</pre></div>
<div class="skip"><span class="num"><pre>  7</pre></span><pre># Copyright 2007 66laps Limited. All Rights Reserved.</pre></div>
<div class="skip"><span class="num"><pre>  8</pre></span><pre>#</pre></div>
<div class="skip"><span class="num"><pre>  9</pre></span><pre># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</pre></div>
<div class="skip"><span class="num"><pre> 10</pre></span><pre># you may not use this file except in compliance with the License.</pre></div>
<div class="skip"><span class="num"><pre> 11</pre></span><pre># You may obtain a copy of the License at</pre></div>
<div class="skip"><span class="num"><pre> 12</pre></span><pre>#</pre></div>
<div class="skip"><span class="num"><pre> 13</pre></span><pre>#     http://www.apache.org/licenses/LICENSE-2.0</pre></div>
<div class="skip"><span class="num"><pre> 14</pre></span><pre>#</pre></div>
<div class="skip"><span class="num"><pre> 15</pre></span><pre># Unless required by applicable law or agreed to in writing, software</pre></div>
<div class="skip"><span class="num"><pre> 16</pre></span><pre># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</pre></div>
<div class="skip"><span class="num"><pre> 17</pre></span><pre># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</pre></div>
<div class="skip"><span class="num"><pre> 18</pre></span><pre># See the License for the specific language governing permissions and</pre></div>
<div class="skip"><span class="num"><pre> 19</pre></span><pre># limitations under the License.</pre></div>
<div class="skip"><span class="num"><pre> 20</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 21</pre></span><pre>__author__  = 'Martin Galpin'</pre></div>
<div class="cov"><span class="num"><pre> 22</pre></span><pre>__contact__ = 'm@66laps.com'</pre></div>
<div class="cov"><span class="num"><pre> 23</pre></span><pre>__version__ = '1.0b'</pre></div>
<div class="cov"><span class="num"><pre> 24</pre></span><pre>__license__ = 'Apache License, Version 2.0'</pre></div>
<div class="skip"><span class="num"><pre> 25</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 26</pre></span><pre>import datetime</pre></div>
<div class="cov"><span class="num"><pre> 27</pre></span><pre>import  os, sys, tempfile, zipfile</pre></div>
<div class="cov"><span class="num"><pre> 28</pre></span><pre>import itertools</pre></div>
<div class="cov"><span class="num"><pre> 29</pre></span><pre>import xml.etree.ElementTree as ET</pre></div>
<div class="cov"><span class="num"><pre> 30</pre></span><pre>import numpy as np</pre></div>
<div class="skip"><span class="num"><pre> 31</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 32</pre></span><pre>from utils import *</pre></div>
<div class="cov"><span class="num"><pre> 33</pre></span><pre>from time import *</pre></div>
<div class="skip"><span class="num"><pre> 34</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 35</pre></span><pre>class Session(object):</pre></div>
<div class="cov"><span class="num"><pre> 36</pre></span><pre>  '''An instance of openmotorsport.Session represents a OpenMotorsport file.'''</pre></div>
<div class="skip"><span class="num"><pre> 37</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre> 38</pre></span><pre>  def __init__(self, filepath=None, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre> 39</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre> 40</pre></span><pre>    Create a new instance of openmotorsport.Session. Either constructs a </pre></div>
<div class="cov"><span class="num"><pre> 41</pre></span><pre>    brand new instance that is empty or loads an existing file.</pre></div>
<div class="skip"><span class="num"><pre> 42</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 43</pre></span><pre>    Args:</pre></div>
<div class="cov"><span class="num"><pre> 44</pre></span><pre>      filepath</pre></div>
<div class="cov"><span class="num"><pre> 45</pre></span><pre>        The path to an existing OpenMotorsport session to load. [optional]</pre></div>
<div class="skip"><span class="num"><pre> 46</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre> 47</pre></span><pre>    '''    </pre></div>
<div class="cov"><span class="num"><pre> 48</pre></span><pre>    self.metadata = Metadata()    </pre></div>
<div class="cov"><span class="num"><pre> 49</pre></span><pre>    self._channels = {}</pre></div>
<div class="cov"><span class="num"><pre> 50</pre></span><pre>    self._groups = {}</pre></div>
<div class="cov"><span class="num"><pre> 51</pre></span><pre>    self._channels_ids = {}</pre></div>
<div class="cov"><span class="num"><pre> 52</pre></span><pre>    self.markers = np.array([], dtype=np.int32)</pre></div>
<div class="cov"><span class="num"><pre> 53</pre></span><pre>    self.num_sectors = None</pre></div>
<div class="cov"><span class="num"><pre> 54</pre></span><pre>    self._laps = []</pre></div>
<div class="skip"><span class="num"><pre> 55</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 56</pre></span><pre>    if filepath:</pre></div>
<div class="cov"><span class="num"><pre> 57</pre></span><pre>      self._load(filepath)</pre></div>
<div class="skip"><span class="num"><pre> 58</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre> 59</pre></span><pre>    self.__dict__.update(**kwargs)</pre></div>
<div class="skip"><span class="num"><pre> 60</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 61</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre> 62</pre></span><pre>  def channels(self):</pre></div>
<div class="cov"><span class="num"><pre> 63</pre></span><pre>    '''Gets a list of Channel instances for this session.'''</pre></div>
<div class="cov"><span class="num"><pre> 64</pre></span><pre>    return self._channels.values()</pre></div>
<div class="skip"><span class="num"><pre> 65</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 66</pre></span><pre>  def __enter__(self):</pre></div>
<div class="cov"><span class="num"><pre> 67</pre></span><pre>    '''Context manager protocol. Returns self.'''</pre></div>
<div class="cov"><span class="num"><pre> 68</pre></span><pre>    return self</pre></div>
<div class="skip"><span class="num"><pre> 69</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 70</pre></span><pre>  def __exit__(self, type, value, traceback):</pre></div>
<div class="cov"><span class="num"><pre> 71</pre></span><pre>    '''Context manager protocol. Automatically closes resources.'''</pre></div>
<div class="cov"><span class="num"><pre> 72</pre></span><pre>    self.close()</pre></div>
<div class="cov"><span class="num"><pre> 73</pre></span><pre>    return False</pre></div>
<div class="skip"><span class="num"><pre> 74</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 75</pre></span><pre>  def close(self):</pre></div>
<div class="cov"><span class="num"><pre> 76</pre></span><pre>    '''Close any open resources.'''</pre></div>
<div class="cov"><span class="num"><pre> 77</pre></span><pre>    self._zipfile.close()</pre></div>
<div class="skip"><span class="num"><pre> 78</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 79</pre></span><pre>  def add_marker(self, marker):</pre></div>
<div class="cov"><span class="num"><pre> 80</pre></span><pre>    '''Adds a markers to the current session.'''</pre></div>
<div class="cov"><span class="num"><pre> 81</pre></span><pre>    self.markers = np.append(self.markers, marker)</pre></div>
<div class="skip"><span class="num"><pre> 82</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 83</pre></span><pre>  def add_channel(self, channel):</pre></div>
<div class="cov"><span class="num"><pre> 84</pre></span><pre>    '''Adds a given instance of Channel to this session.'''</pre></div>
<div class="cov"><span class="num"><pre> 85</pre></span><pre>    self._channels['%s/%s' % (channel.name, channel.group)] = channel</pre></div>
<div class="cov"><span class="num"><pre> 86</pre></span><pre>    self._channels_ids[str(channel.id)] = channel</pre></div>
<div class="cov"><span class="num"><pre> 87</pre></span><pre>    if not channel.group in self._groups:</pre></div>
<div class="cov"><span class="num"><pre> 88</pre></span><pre>      self._groups[channel.group] = []</pre></div>
<div class="cov"><span class="num"><pre> 89</pre></span><pre>    self._groups[channel.group].append(channel)</pre></div>
<div class="skip"><span class="num"><pre> 90</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre> 91</pre></span><pre>  def get_channel(self, name, group=None):</pre></div>
<div class="cov"><span class="num"><pre> 92</pre></span><pre>    '''Gets a channels that matches a given name and group.'''</pre></div>
<div class="cov"><span class="num"><pre> 93</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre> 94</pre></span><pre>      return self._channels['%s/%s' % (name, group)]</pre></div>
<div class="cov"><span class="num"><pre> 95</pre></span><pre>    except KeyError:</pre></div>
<div class="cov"><span class="num"><pre> 96</pre></span><pre>      return None</pre></div>
<div class="skip"><span class="num"><pre> 97</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre> 98</pre></span><pre>  def get_channel_by_id(self, id):</pre></div>
<div class="cov"><span class="num"><pre> 99</pre></span><pre>    '''Gets a channels that matches a given id.'''</pre></div>
<div class="cov"><span class="num"><pre>100</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>101</pre></span><pre>      return self._channels_ids[str(id)]</pre></div>
<div class="cov"><span class="num"><pre>102</pre></span><pre>    except KeyError:</pre></div>
<div class="cov"><span class="num"><pre>103</pre></span><pre>      return None      </pre></div>
<div class="skip"><span class="num"><pre>104</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>105</pre></span><pre>  def get_group(self, group):</pre></div>
<div class="cov"><span class="num"><pre>106</pre></span><pre>    '''Gets a list of channels in a given group.'''</pre></div>
<div class="cov"><span class="num"><pre>107</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>108</pre></span><pre>      return self._groups[group]</pre></div>
<div class="cov"><span class="num"><pre>109</pre></span><pre>    except KeyError:</pre></div>
<div class="cov"><span class="num"><pre>110</pre></span><pre>      return None</pre></div>
<div class="skip"><span class="num"><pre>111</pre></span><pre>          </pre></div>
<div class="cov"><span class="num"><pre>112</pre></span><pre>  def _getlaps(self):</pre></div>
<div class="cov"><span class="num"><pre>113</pre></span><pre>    '''Lazy initialized getter for laps (laps are calculated from markers).'''</pre></div>
<div class="cov"><span class="num"><pre>114</pre></span><pre>    if not self._laps:</pre></div>
<div class="cov"><span class="num"><pre>115</pre></span><pre>      self.refresh_laps()</pre></div>
<div class="cov"><span class="num"><pre>116</pre></span><pre>    return self._laps</pre></div>
<div class="skip"><span class="num"><pre>117</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>118</pre></span><pre>  laps = property(_getlaps)    </pre></div>
<div class="cov"><span class="num"><pre>119</pre></span><pre>  '''A list of openmotorsport.Lap instances for this session. Laps are </pre></div>
<div class="cov"><span class="num"><pre>120</pre></span><pre>  calculated based on the number of the markers and sectors per lap.'''</pre></div>
<div class="skip"><span class="num"><pre>121</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>122</pre></span><pre>  def write(self, filepath):</pre></div>
<div class="cov"><span class="num"><pre>123</pre></span><pre>    '''Write this instance to an OpenMotorsport file and returns the filepath.'''</pre></div>
<div class="cov"><span class="num"><pre>124</pre></span><pre>    def write_binary(array, zipfile, arcname):</pre></div>
<div class="cov"><span class="num"><pre>125</pre></span><pre>      tup = tempfile.mkstemp()            </pre></div>
<div class="cov"><span class="num"><pre>126</pre></span><pre>      array.tofile(os.fdopen(tup[0], &quot;wb&quot;))        </pre></div>
<div class="cov"><span class="num"><pre>127</pre></span><pre>      zipfile.write(tup[1], arcname=arcname)</pre></div>
<div class="cov"><span class="num"><pre>128</pre></span><pre>      os.remove(tup[1])</pre></div>
<div class="skip"><span class="num"><pre>129</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>130</pre></span><pre>    try:    </pre></div>
<div class="cov"><span class="num"><pre>131</pre></span><pre>      self._zipfile = zipfile.ZipFile(filepath, 'w', zipfile.ZIP_DEFLATED)</pre></div>
<div class="cov"><span class="num"><pre>132</pre></span><pre>      self._zipfile.writestr('meta.xml', self._write_meta())            </pre></div>
<div class="skip"><span class="num"><pre>133</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>134</pre></span><pre>      for c in self.channels:</pre></div>
<div class="cov"><span class="num"><pre>135</pre></span><pre>        write_binary(c.timeseries.data, self._zipfile, 'data/%s.bin' % c.id)</pre></div>
<div class="cov"><span class="num"><pre>136</pre></span><pre>        if not hasattr(c.timeseries, &quot;frequency&quot;):</pre></div>
<div class="cov"><span class="num"><pre>137</pre></span><pre>          write_binary(c.timeseries.times, self._zipfile, 'data/%s.tms' % c.id)</pre></div>
<div class="skip"><span class="num"><pre>138</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>139</pre></span><pre>      self._zipfile.close()</pre></div>
<div class="cov"><span class="num"><pre>140</pre></span><pre>      return filepath</pre></div>
<div class="cov"><span class="num"><pre>141</pre></span><pre>    except:</pre></div>
<div class="skip"><span class="num"><pre>142</pre></span><pre>      # delete a partial file on error</pre></div>
<div class="cov"><span class="num"><pre>143</pre></span><pre>      os.remove(filepath)</pre></div>
<div class="cov"><span class="num"><pre>144</pre></span><pre>      raise</pre></div>
<div class="skip"><span class="num"><pre>145</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>146</pre></span><pre>  def _read_channel_data(self, channel_id):</pre></div>
<div class="cov"><span class="num"><pre>147</pre></span><pre>    p = 'data/%s.bin' % channel_id</pre></div>
<div class="cov"><span class="num"><pre>148</pre></span><pre>    return np.fromfile(self._zipfile.extract(p, self._tempdir), dtype=np.float32)</pre></div>
<div class="skip"><span class="num"><pre>149</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>150</pre></span><pre>  def _read_channel_times(self, channel_id):</pre></div>
<div class="cov"><span class="num"><pre>151</pre></span><pre>    p = 'data/%s.tms' % channel_id</pre></div>
<div class="cov"><span class="num"><pre>152</pre></span><pre>    return np.fromfile(self._zipfile.extract(p, self._tempdir), dtype=np.int32)  </pre></div>
<div class="skip"><span class="num"><pre>153</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>154</pre></span><pre>  def _write_meta(self):</pre></div>
<div class="cov"><span class="num"><pre>155</pre></span><pre>    '''Generate the meta.xml file and return the contents as a string.'''</pre></div>
<div class="cov"><span class="num"><pre>156</pre></span><pre>    root = ET.Element('openmotorsport')</pre></div>
<div class="cov"><span class="num"><pre>157</pre></span><pre>    root.attrib['xmlns'] = BASE_NS</pre></div>
<div class="skip"><span class="num"><pre>158</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>159</pre></span><pre>    # metadata</pre></div>
<div class="cov"><span class="num"><pre>160</pre></span><pre>    meta = ET.SubElement(root, 'metadata')</pre></div>
<div class="skip"><span class="num"><pre>161</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>162</pre></span><pre>    # user</pre></div>
<div class="cov"><span class="num"><pre>163</pre></span><pre>    ET.SubElement(meta, 'user').text = self.metadata.user</pre></div>
<div class="skip"><span class="num"><pre>164</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>165</pre></span><pre>    # venue (only circuit is mandatory)</pre></div>
<div class="cov"><span class="num"><pre>166</pre></span><pre>    venue = ET.SubElement(meta, 'venue')</pre></div>
<div class="cov"><span class="num"><pre>167</pre></span><pre>    SubElementFromDict(venue, self.metadata.venue, 'name')</pre></div>
<div class="cov"><span class="num"><pre>168</pre></span><pre>    SubElementFromDictConditional(venue, self.metadata.venue, 'configuration')</pre></div>
<div class="skip"><span class="num"><pre>169</pre></span><pre>        </pre></div>
<div class="skip"><span class="num"><pre>170</pre></span><pre>    # vehicle (manufactuer, model is mandatory)</pre></div>
<div class="cov"><span class="num"><pre>171</pre></span><pre>    vehicle = ET.SubElement(meta, 'vehicle')</pre></div>
<div class="cov"><span class="num"><pre>172</pre></span><pre>    SubElementFromDict(vehicle, self.metadata.vehicle, 'name')</pre></div>
<div class="cov"><span class="num"><pre>173</pre></span><pre>    SubElementFromDictConditional(vehicle, self.metadata.vehicle, 'year')</pre></div>
<div class="cov"><span class="num"><pre>174</pre></span><pre>    SubElementFromDictConditional(vehicle, self.metadata.vehicle, 'category')</pre></div>
<div class="cov"><span class="num"><pre>175</pre></span><pre>    SubElementFromDictConditional(vehicle, self.metadata.vehicle, 'comments')</pre></div>
<div class="skip"><span class="num"><pre>176</pre></span><pre>      </pre></div>
<div class="skip"><span class="num"><pre>177</pre></span><pre>    # date in ISO-8601</pre></div>
<div class="cov"><span class="num"><pre>178</pre></span><pre>    ET.SubElement(meta, 'date').text = to_iso8601_date(self.metadata.date)</pre></div>
<div class="skip"><span class="num"><pre>179</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>180</pre></span><pre>    # comments</pre></div>
<div class="cov"><span class="num"><pre>181</pre></span><pre>    if self.metadata.comments:</pre></div>
<div class="cov"><span class="num"><pre>182</pre></span><pre>      ET.SubElement(meta, 'comments').text = self.metadata.comments</pre></div>
<div class="skip"><span class="num"><pre>183</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>184</pre></span><pre>    # datasource</pre></div>
<div class="cov"><span class="num"><pre>185</pre></span><pre>    if self.metadata.datasource:</pre></div>
<div class="cov"><span class="num"><pre>186</pre></span><pre>      ET.SubElement(meta, 'datasource').text = self.metadata.datasource</pre></div>
<div class="skip"><span class="num"><pre>187</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>188</pre></span><pre>    # channels and groups</pre></div>
<div class="cov"><span class="num"><pre>189</pre></span><pre>    def write_channel(root, groups, channel):</pre></div>
<div class="skip"><span class="num"><pre>190</pre></span><pre>      # channel parent node</pre></div>
<div class="cov"><span class="num"><pre>191</pre></span><pre>      if channel.group:</pre></div>
<div class="cov"><span class="num"><pre>192</pre></span><pre>        if channel.group in groups:</pre></div>
<div class="cov"><span class="num"><pre>193</pre></span><pre>          root = groups[channel.group]</pre></div>
<div class="cov"><span class="num"><pre>194</pre></span><pre>        else:</pre></div>
<div class="cov"><span class="num"><pre>195</pre></span><pre>          root = ET.SubElement(root, 'group')</pre></div>
<div class="cov"><span class="num"><pre>196</pre></span><pre>          ET.SubElement(root, 'name').text = channel.group</pre></div>
<div class="cov"><span class="num"><pre>197</pre></span><pre>          groups[channel.group] = root</pre></div>
<div class="skip"><span class="num"><pre>198</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>199</pre></span><pre>      node = ET.SubElement(root, 'channel')</pre></div>
<div class="skip"><span class="num"><pre>200</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>201</pre></span><pre>      node.attrib['id'] = str(channel.id)</pre></div>
<div class="skip"><span class="num"><pre>202</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>203</pre></span><pre>      if hasattr(channel.timeseries, &quot;frequency&quot;):</pre></div>
<div class="cov"><span class="num"><pre>204</pre></span><pre>        node.attrib[&quot;interval&quot;] = str(channel.timeseries.frequency.interval)</pre></div>
<div class="cov"><span class="num"><pre>205</pre></span><pre>      if channel.units:</pre></div>
<div class="cov"><span class="num"><pre>206</pre></span><pre>        node.attrib['units'] = channel.units</pre></div>
<div class="skip"><span class="num"><pre>207</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>208</pre></span><pre>      ET.SubElement(node, 'name').text = channel.name</pre></div>
<div class="cov"><span class="num"><pre>209</pre></span><pre>      if channel.description:</pre></div>
<div class="cov"><span class="num"><pre>210</pre></span><pre>        ET.SubElement(node, 'description').text = channel.description</pre></div>
<div class="skip"><span class="num"><pre>211</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>212</pre></span><pre>    channels = ET.SubElement(root, 'channels')</pre></div>
<div class="cov"><span class="num"><pre>213</pre></span><pre>    groups = {}</pre></div>
<div class="cov"><span class="num"><pre>214</pre></span><pre>    for obj in self.channels:</pre></div>
<div class="cov"><span class="num"><pre>215</pre></span><pre>      write_channel(channels, groups, obj)</pre></div>
<div class="skip"><span class="num"><pre>216</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>217</pre></span><pre>    # markers</pre></div>
<div class="cov"><span class="num"><pre>218</pre></span><pre>    markers = ET.SubElement(root, 'markers')</pre></div>
<div class="cov"><span class="num"><pre>219</pre></span><pre>    if self.num_sectors is not None:</pre></div>
<div class="cov"><span class="num"><pre>220</pre></span><pre>      markers.attrib[&quot;sectors&quot;] = str(self.num_sectors)</pre></div>
<div class="skip"><span class="num"><pre>221</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>222</pre></span><pre>    for marker in self.markers:</pre></div>
<div class="cov"><span class="num"><pre>223</pre></span><pre>      node = ET.SubElement(markers, 'marker')</pre></div>
<div class="cov"><span class="num"><pre>224</pre></span><pre>      node.attrib[&quot;time&quot;] = '%d' % int(marker)</pre></div>
<div class="skip"><span class="num"><pre>225</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>226</pre></span><pre>    return ET.tostring(root, encoding='UTF-8')</pre></div>
<div class="skip"><span class="num"><pre>227</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>228</pre></span><pre>  def _load(self, filepath):</pre></div>
<div class="cov"><span class="num"><pre>229</pre></span><pre>    '''Read an OpenMotorsport file from a given filepath.'''</pre></div>
<div class="cov"><span class="num"><pre>230</pre></span><pre>    self._tempdir = tempfile.mkdtemp() </pre></div>
<div class="cov"><span class="num"><pre>231</pre></span><pre>    self._zipfile = zipfile.ZipFile(filepath, 'r', zipfile.ZIP_DEFLATED)</pre></div>
<div class="skip"><span class="num"><pre>232</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>233</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>234</pre></span><pre>      metafilepath = self._zipfile.extract('meta.xml', self._tempdir)</pre></div>
<div class="cov"><span class="num"><pre>235</pre></span><pre>      root = ET.parse(metafilepath).getroot()    </pre></div>
<div class="cov"><span class="num"><pre>236</pre></span><pre>      self._parse_meta(root)</pre></div>
<div class="cov"><span class="num"><pre>237</pre></span><pre>      self._parse_markers(root)      </pre></div>
<div class="cov"><span class="num"><pre>238</pre></span><pre>      self._parse_channels(root)</pre></div>
<div class="cov"><span class="num"><pre>239</pre></span><pre>    except Exception, e:</pre></div>
<div class="cov"><span class="num"><pre>240</pre></span><pre>      raise Exception('Failed to import' + filepath, e), None, sys.exc_info()[2]</pre></div>
<div class="skip"><span class="num"><pre>241</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>242</pre></span><pre>    # the zipfile is left open (for lazy loading of data)             </pre></div>
<div class="skip"><span class="num"><pre>243</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>244</pre></span><pre>  def _parse_meta(self, root):</pre></div>
<div class="cov"><span class="num"><pre>245</pre></span><pre>    '''Parses meta.xml/metadata from a given ElementTree root node.'''</pre></div>
<div class="skip"><span class="num"><pre>246</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>247</pre></span><pre>    def read(root, path, dict, key):</pre></div>
<div class="cov"><span class="num"><pre>248</pre></span><pre>      dict[key] = root.findtext('%s/%s' % (ns(path), ns(key)))</pre></div>
<div class="skip"><span class="num"><pre>249</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>250</pre></span><pre>    node = root.find(ns('metadata'))</pre></div>
<div class="skip"><span class="num"><pre>251</pre></span><pre>                </pre></div>
<div class="skip"><span class="num"><pre>252</pre></span><pre>    # read user</pre></div>
<div class="cov"><span class="num"><pre>253</pre></span><pre>    self.metadata.user = node.findtext(ns('user'))</pre></div>
<div class="skip"><span class="num"><pre>254</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>255</pre></span><pre>    # read vehicle</pre></div>
<div class="cov"><span class="num"><pre>256</pre></span><pre>    read(node, 'vehicle', self.metadata.vehicle, 'name') </pre></div>
<div class="cov"><span class="num"><pre>257</pre></span><pre>    read(node, 'vehicle', self.metadata.vehicle, 'year') </pre></div>
<div class="cov"><span class="num"><pre>258</pre></span><pre>    read(node, 'vehicle', self.metadata.vehicle, 'category') </pre></div>
<div class="cov"><span class="num"><pre>259</pre></span><pre>    read(node, 'vehicle', self.metadata.vehicle, 'comments') </pre></div>
<div class="skip"><span class="num"><pre>260</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>261</pre></span><pre>    # read venue</pre></div>
<div class="cov"><span class="num"><pre>262</pre></span><pre>    read(node, 'venue', self.metadata.venue, 'name')</pre></div>
<div class="cov"><span class="num"><pre>263</pre></span><pre>    read(node, 'venue', self.metadata.venue, 'configuration')</pre></div>
<div class="skip"><span class="num"><pre>264</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>265</pre></span><pre>    # read date</pre></div>
<div class="cov"><span class="num"><pre>266</pre></span><pre>    date = datetime.datetime.now()    </pre></div>
<div class="cov"><span class="num"><pre>267</pre></span><pre>    self.metadata.date = from_iso8601_date(node.find(ns('date')).text)</pre></div>
<div class="skip"><span class="num"><pre>268</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>269</pre></span><pre>    # read comments</pre></div>
<div class="cov"><span class="num"><pre>270</pre></span><pre>    self.metadata.comments = node.findtext(ns('comments'))</pre></div>
<div class="skip"><span class="num"><pre>271</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>272</pre></span><pre>    # read datasource</pre></div>
<div class="cov"><span class="num"><pre>273</pre></span><pre>    self.metadata.datasource = node.findtext(ns('datasource'))    </pre></div>
<div class="skip"><span class="num"><pre>274</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>275</pre></span><pre>  def _parse_channels(self, root, group=None):</pre></div>
<div class="cov"><span class="num"><pre>276</pre></span><pre>    '''Parses meta.xml/channels (and groups) from a given ElementTree root.'''</pre></div>
<div class="cov"><span class="num"><pre>277</pre></span><pre>    def parse_channel(node, group=None):</pre></div>
<div class="cov"><span class="num"><pre>278</pre></span><pre>      id = int(node.get('id'))</pre></div>
<div class="cov"><span class="num"><pre>279</pre></span><pre>      interval = node.get('interval')</pre></div>
<div class="cov"><span class="num"><pre>280</pre></span><pre>      if interval is None:</pre></div>
<div class="cov"><span class="num"><pre>281</pre></span><pre>        timeseries = LazyVariableTimeSeries(parent=self, channel_id=id)</pre></div>
<div class="cov"><span class="num"><pre>282</pre></span><pre>      else:</pre></div>
<div class="cov"><span class="num"><pre>283</pre></span><pre>        timeseries = LazyUniformTimeSeries(</pre></div>
<div class="cov"><span class="num"><pre>284</pre></span><pre>          parent=self, channel_id=id,</pre></div>
<div class="cov"><span class="num"><pre>285</pre></span><pre>          frequency=Frequency.from_interval(interval)</pre></div>
<div class="cov"><span class="num"><pre>286</pre></span><pre>        )</pre></div>
<div class="skip"><span class="num"><pre>287</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>288</pre></span><pre>      channel = Channel(</pre></div>
<div class="cov"><span class="num"><pre>289</pre></span><pre>        id = node.get('id'),</pre></div>
<div class="cov"><span class="num"><pre>290</pre></span><pre>        name = node.findtext(ns('name')),</pre></div>
<div class="cov"><span class="num"><pre>291</pre></span><pre>        timeseries = timeseries,</pre></div>
<div class="cov"><span class="num"><pre>292</pre></span><pre>        units = node.get('units'),</pre></div>
<div class="cov"><span class="num"><pre>293</pre></span><pre>        description = node.findtext(ns('description')),</pre></div>
<div class="cov"><span class="num"><pre>294</pre></span><pre>        group = group</pre></div>
<div class="cov"><span class="num"><pre>295</pre></span><pre>      )</pre></div>
<div class="cov"><span class="num"><pre>296</pre></span><pre>      channel.__parent__ = self # a reference to this session for lazy loading</pre></div>
<div class="cov"><span class="num"><pre>297</pre></span><pre>      return channel</pre></div>
<div class="skip"><span class="num"><pre>298</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>299</pre></span><pre>    def parse_channels(root, group=None):</pre></div>
<div class="cov"><span class="num"><pre>300</pre></span><pre>      for node in root.getchildren():</pre></div>
<div class="cov"><span class="num"><pre>301</pre></span><pre>        if node.tag == ns('channel'):</pre></div>
<div class="cov"><span class="num"><pre>302</pre></span><pre>          self.add_channel(parse_channel(node, group))</pre></div>
<div class="cov"><span class="num"><pre>303</pre></span><pre>        elif node.tag == ns('group'):</pre></div>
<div class="cov"><span class="num"><pre>304</pre></span><pre>          parse_channels(node, node.findtext(ns('name')))</pre></div>
<div class="skip"><span class="num"><pre>305</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>306</pre></span><pre>    parse_channels(root.find(ns('channels')))</pre></div>
<div class="skip"><span class="num"><pre>307</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>308</pre></span><pre>  def _parse_markers(self, root):</pre></div>
<div class="cov"><span class="num"><pre>309</pre></span><pre>    '''Parses meta.xml/markers from a given ElementTree root.'''</pre></div>
<div class="cov"><span class="num"><pre>310</pre></span><pre>    node = root.find(ns('markers'))</pre></div>
<div class="cov"><span class="num"><pre>311</pre></span><pre>    if not node:</pre></div>
<div class="cov"><span class="num"><pre>312</pre></span><pre>      return</pre></div>
<div class="cov"><span class="num"><pre>313</pre></span><pre>    self.num_sectors = int(node.get('sectors')) if node.get('sectors') else None</pre></div>
<div class="cov"><span class="num"><pre>314</pre></span><pre>    markers = node.findall(ns('marker'))    </pre></div>
<div class="cov"><span class="num"><pre>315</pre></span><pre>    [self.add_marker(float(x.get('time'))) for x in markers]</pre></div>
<div class="skip"><span class="num"><pre>316</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>317</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>318</pre></span><pre>  def refresh_laps(self): </pre></div>
<div class="cov"><span class="num"><pre>319</pre></span><pre>    '''Calculates laps based on the sessions markers and number of sectors.</pre></div>
<div class="skip"><span class="num"><pre>320</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>321</pre></span><pre>    Returns:</pre></div>
<div class="cov"><span class="num"><pre>322</pre></span><pre>      A list of Lap instances.</pre></div>
<div class="cov"><span class="num"><pre>323</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre>324</pre></span><pre>    def make_relative(time, laps): </pre></div>
<div class="cov"><span class="num"><pre>325</pre></span><pre>      return time if not laps else time - sum([lap.length for lap in laps])</pre></div>
<div class="skip"><span class="num"><pre>326</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>327</pre></span><pre>    def make_start_time(laps):</pre></div>
<div class="cov"><span class="num"><pre>328</pre></span><pre>      return 0.0 if not laps else (laps[-1].offset + laps[-1].length)</pre></div>
<div class="skip"><span class="num"><pre>329</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>330</pre></span><pre>    def make_relative_sector(time, sectors):</pre></div>
<div class="cov"><span class="num"><pre>331</pre></span><pre>      return time if not sectors else time - sum(sectors) </pre></div>
<div class="skip"><span class="num"><pre>332</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>333</pre></span><pre>    def grouper(iterable, n, fillvalue=None):</pre></div>
<div class="cov"><span class="num"><pre>334</pre></span><pre>      return itertools.izip_longest(*[iter(iterable)]*n, fillvalue=fillvalue)</pre></div>
<div class="skip"><span class="num"><pre>335</pre></span><pre>    </pre></div>
<div class="skip"><span class="num"><pre>336</pre></span><pre>    # when num_sectors is None we take that to mean there are no laps.</pre></div>
<div class="cov"><span class="num"><pre>337</pre></span><pre>    if self.num_sectors is None:</pre></div>
<div class="cov"><span class="num"><pre>338</pre></span><pre>      return</pre></div>
<div class="skip"><span class="num"><pre>339</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>340</pre></span><pre>    self._laps[:] = []</pre></div>
<div class="cov"><span class="num"><pre>341</pre></span><pre>    for g in grouper(self.markers, self.num_sectors + 1):</pre></div>
<div class="cov"><span class="num"><pre>342</pre></span><pre>      sectors = []</pre></div>
<div class="cov"><span class="num"><pre>343</pre></span><pre>      for s in g[:-1]:</pre></div>
<div class="cov"><span class="num"><pre>344</pre></span><pre>        sectors.append(make_relative_sector(make_relative(s, self._laps), sectors) if s else None)</pre></div>
<div class="skip"><span class="num"><pre>345</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>346</pre></span><pre>      lap = Lap(</pre></div>
<div class="cov"><span class="num"><pre>347</pre></span><pre>        sectors = sectors,</pre></div>
<div class="cov"><span class="num"><pre>348</pre></span><pre>        length = make_relative(g[-1], self._laps) if g[-1] else None,</pre></div>
<div class="cov"><span class="num"><pre>349</pre></span><pre>        offset = make_start_time(self._laps)</pre></div>
<div class="cov"><span class="num"><pre>350</pre></span><pre>      )</pre></div>
<div class="cov"><span class="num"><pre>351</pre></span><pre>      lap.__parent__ = self</pre></div>
<div class="cov"><span class="num"><pre>352</pre></span><pre>      self._laps.append(lap) </pre></div>
<div class="skip"><span class="num"><pre>353</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>354</pre></span><pre>  def __repr__(self):</pre></div>
<div class="cov"><span class="num"><pre>355</pre></span><pre>    return '%s' % self.metadata  </pre></div>
<div class="skip"><span class="num"><pre>356</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>357</pre></span><pre>  def __eq__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>358</pre></span><pre>    try:</pre></div>
<div class="cov"><span class="num"><pre>359</pre></span><pre>      return other and \</pre></div>
<div class="cov"><span class="num"><pre>360</pre></span><pre>            self.metadata == other.metadata and \</pre></div>
<div class="cov"><span class="num"><pre>361</pre></span><pre>            self.num_sectors == other.num_sectors and \</pre></div>
<div class="cov"><span class="num"><pre>362</pre></span><pre>            self.channels == other.channels and \</pre></div>
<div class="cov"><span class="num"><pre>363</pre></span><pre>            np.equal(self.markers, other.markers).all()</pre></div>
<div class="cov"><span class="num"><pre>364</pre></span><pre>    except:</pre></div>
<div class="cov"><span class="num"><pre>365</pre></span><pre>      return False</pre></div>
<div class="skip"><span class="num"><pre>366</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>367</pre></span><pre>  def __ne__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>368</pre></span><pre>    return not self.__eq__(other)</pre></div>
<div class="skip"><span class="num"><pre>369</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>370</pre></span><pre>class Lap(Epoch):</pre></div>
<div class="cov"><span class="num"><pre>371</pre></span><pre>  '''</pre></div>
<div class="cov"><span class="num"><pre>372</pre></span><pre>  This class represents a single lap. It is a subclass of time.Epoch,</pre></div>
<div class="cov"><span class="num"><pre>373</pre></span><pre>  adding a list of sector times and additional lap-specific methods.</pre></div>
<div class="cov"><span class="num"><pre>374</pre></span><pre>  '''</pre></div>
<div class="cov"><span class="num"><pre>375</pre></span><pre>  def __init__(self, length, offset=0, sectors=[]):</pre></div>
<div class="cov"><span class="num"><pre>376</pre></span><pre>    super(Epoch, self).__init__()</pre></div>
<div class="cov"><span class="num"><pre>377</pre></span><pre>    self._length = length</pre></div>
<div class="cov"><span class="num"><pre>378</pre></span><pre>    self._offset = offset</pre></div>
<div class="cov"><span class="num"><pre>379</pre></span><pre>    self._sectors = sectors</pre></div>
<div class="skip"><span class="num"><pre>380</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>381</pre></span><pre>    self._difference = None</pre></div>
<div class="cov"><span class="num"><pre>382</pre></span><pre>    self.__parent__ = None</pre></div>
<div class="skip"><span class="num"><pre>383</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>384</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>385</pre></span><pre>  def end_time(self):</pre></div>
<div class="cov"><span class="num"><pre>386</pre></span><pre>    '''Gets the time (in seconds that this lap ends).</pre></div>
<div class="cov"><span class="num"><pre>387</pre></span><pre>    If this lap is incomplete then end_time will be equal to the time</pre></div>
<div class="cov"><span class="num"><pre>388</pre></span><pre>    of the last data sample.'''</pre></div>
<div class="cov"><span class="num"><pre>389</pre></span><pre>    if self.length is not None:</pre></div>
<div class="cov"><span class="num"><pre>390</pre></span><pre>      return self.offset + self.length</pre></div>
<div class="cov"><span class="num"><pre>391</pre></span><pre>    else:</pre></div>
<div class="cov"><span class="num"><pre>392</pre></span><pre>      if not self.sectors:</pre></div>
<div class="cov"><span class="num"><pre>393</pre></span><pre>        return self.offset</pre></div>
<div class="cov"><span class="num"><pre>394</pre></span><pre>      return self.offset + self.sectors[-1]</pre></div>
<div class="skip"><span class="num"><pre>395</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>396</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>397</pre></span><pre>  def sectors(self):</pre></div>
<div class="cov"><span class="num"><pre>398</pre></span><pre>    '''Gets a list of sector times (in seconds).'''</pre></div>
<div class="cov"><span class="num"><pre>399</pre></span><pre>    return self._sectors</pre></div>
<div class="skip"><span class="num"><pre>400</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>401</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>402</pre></span><pre>  def difference(self):</pre></div>
<div class="cov"><span class="num"><pre>403</pre></span><pre>    '''Gets the difference in time between this lap and its previous lap.'''</pre></div>
<div class="cov"><span class="num"><pre>404</pre></span><pre>    if not self._difference and self.__parent__ is not None:</pre></div>
<div class="cov"><span class="num"><pre>405</pre></span><pre>      self._difference = lap_difference(self.__parent__, self)</pre></div>
<div class="cov"><span class="num"><pre>406</pre></span><pre>    return self._difference</pre></div>
<div class="skip"><span class="num"><pre>407</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>408</pre></span><pre>  def __repr__(self):</pre></div>
<div class="cov"><span class="num"><pre>409</pre></span><pre>    return '%d (%s)' % (self._length, self._sectors)</pre></div>
<div class="skip"><span class="num"><pre>410</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>411</pre></span><pre>  def __eq__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>412</pre></span><pre>    return other and \</pre></div>
<div class="cov"><span class="num"><pre>413</pre></span><pre>      self.length == other.length and \</pre></div>
<div class="cov"><span class="num"><pre>414</pre></span><pre>      self.sectors == other.sectors and \</pre></div>
<div class="cov"><span class="num"><pre>415</pre></span><pre>      self.offset == other.offset</pre></div>
<div class="skip"><span class="num"><pre>416</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>417</pre></span><pre>  def __ne__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>418</pre></span><pre>    return not self.__eq__(other)</pre></div>
<div class="skip"><span class="num"><pre>419</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>420</pre></span><pre>class Channel(object):</pre></div>
<div class="cov"><span class="num"><pre>421</pre></span><pre>  '''This class represents a single channel within an OpenMotorsport file.'''</pre></div>
<div class="cov"><span class="num"><pre>422</pre></span><pre>  def __init__(self,</pre></div>
<div class="cov"><span class="num"><pre>423</pre></span><pre>              id,</pre></div>
<div class="cov"><span class="num"><pre>424</pre></span><pre>              name=None,              </pre></div>
<div class="cov"><span class="num"><pre>425</pre></span><pre>              group=None,</pre></div>
<div class="cov"><span class="num"><pre>426</pre></span><pre>              units=None,</pre></div>
<div class="cov"><span class="num"><pre>427</pre></span><pre>              description=None,</pre></div>
<div class="cov"><span class="num"><pre>428</pre></span><pre>              timeseries=VariableTimeSeries()):</pre></div>
<div class="cov"><span class="num"><pre>429</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre>430</pre></span><pre>    Contructs a new instance of Channel.</pre></div>
<div class="skip"><span class="num"><pre>431</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>432</pre></span><pre>    Arguments:</pre></div>
<div class="cov"><span class="num"><pre>433</pre></span><pre>      id</pre></div>
<div class="cov"><span class="num"><pre>434</pre></span><pre>        The unique identifier for this channel.</pre></div>
<div class="cov"><span class="num"><pre>435</pre></span><pre>      name</pre></div>
<div class="cov"><span class="num"><pre>436</pre></span><pre>        The channel name. [optional]</pre></div>
<div class="cov"><span class="num"><pre>437</pre></span><pre>      group</pre></div>
<div class="cov"><span class="num"><pre>438</pre></span><pre>        The channel group name. [optional]</pre></div>
<div class="cov"><span class="num"><pre>439</pre></span><pre>      units</pre></div>
<div class="cov"><span class="num"><pre>440</pre></span><pre>        The abbreviated units of measurement for this channel. [optional]</pre></div>
<div class="cov"><span class="num"><pre>441</pre></span><pre>      description</pre></div>
<div class="cov"><span class="num"><pre>442</pre></span><pre>        A textual description of this channel. [optional]</pre></div>
<div class="cov"><span class="num"><pre>443</pre></span><pre>      timeseries</pre></div>
<div class="cov"><span class="num"><pre>444</pre></span><pre>        An initial timeseries for this channel. If none is specified, it</pre></div>
<div class="cov"><span class="num"><pre>445</pre></span><pre>        will default to an empty instance of VariableTimeSeries. [optional].</pre></div>
<div class="cov"><span class="num"><pre>446</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre>447</pre></span><pre>    self._id = int(id)</pre></div>
<div class="cov"><span class="num"><pre>448</pre></span><pre>    self._name = name</pre></div>
<div class="cov"><span class="num"><pre>449</pre></span><pre>    self._group = group</pre></div>
<div class="cov"><span class="num"><pre>450</pre></span><pre>    self._units = units</pre></div>
<div class="cov"><span class="num"><pre>451</pre></span><pre>    self._description = description</pre></div>
<div class="cov"><span class="num"><pre>452</pre></span><pre>    self._timeseries = timeseries</pre></div>
<div class="cov"><span class="num"><pre>453</pre></span><pre>    self.__parent__ = None</pre></div>
<div class="skip"><span class="num"><pre>454</pre></span><pre>        </pre></div>
<div class="cov"><span class="num"><pre>455</pre></span><pre>  @property </pre></div>
<div class="cov"><span class="num"><pre>456</pre></span><pre>  def name(self):</pre></div>
<div class="cov"><span class="num"><pre>457</pre></span><pre>    '''Gets the channel name [read-only].'''</pre></div>
<div class="cov"><span class="num"><pre>458</pre></span><pre>    return self._name</pre></div>
<div class="skip"><span class="num"><pre>459</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>460</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>461</pre></span><pre>  def id(self):</pre></div>
<div class="cov"><span class="num"><pre>462</pre></span><pre>    '''Gets the channel id [read-only].'''</pre></div>
<div class="cov"><span class="num"><pre>463</pre></span><pre>    return self._id</pre></div>
<div class="skip"><span class="num"><pre>464</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>465</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>466</pre></span><pre>  def group(self):</pre></div>
<div class="cov"><span class="num"><pre>467</pre></span><pre>    '''Gets the channel group [read-only].'''</pre></div>
<div class="cov"><span class="num"><pre>468</pre></span><pre>    return self._group</pre></div>
<div class="skip"><span class="num"><pre>469</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>470</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>471</pre></span><pre>  def units(self):</pre></div>
<div class="cov"><span class="num"><pre>472</pre></span><pre>    '''Gets the channel units [read-only].'''</pre></div>
<div class="cov"><span class="num"><pre>473</pre></span><pre>    return self._units</pre></div>
<div class="skip"><span class="num"><pre>474</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>475</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>476</pre></span><pre>  def description(self):</pre></div>
<div class="cov"><span class="num"><pre>477</pre></span><pre>    '''Gets the channel description [read-only].'''</pre></div>
<div class="cov"><span class="num"><pre>478</pre></span><pre>    return self._description</pre></div>
<div class="skip"><span class="num"><pre>479</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>480</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>481</pre></span><pre>  def timeseries(self):</pre></div>
<div class="cov"><span class="num"><pre>482</pre></span><pre>    '''Gets the channel timeseries [read-only].'''</pre></div>
<div class="cov"><span class="num"><pre>483</pre></span><pre>    return self._timeseries</pre></div>
<div class="skip"><span class="num"><pre>484</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>485</pre></span><pre>  def __repr__(self):</pre></div>
<div class="cov"><span class="num"><pre>486</pre></span><pre>    return 'Channel %s (%s)' % (self.name, self.group)</pre></div>
<div class="skip"><span class="num"><pre>487</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>488</pre></span><pre>  def __eq__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>489</pre></span><pre>    return other and \</pre></div>
<div class="cov"><span class="num"><pre>490</pre></span><pre>          self.id == other.id and \</pre></div>
<div class="cov"><span class="num"><pre>491</pre></span><pre>          self.name == other.name and \</pre></div>
<div class="cov"><span class="num"><pre>492</pre></span><pre>          self.group == other.group and \</pre></div>
<div class="cov"><span class="num"><pre>493</pre></span><pre>          self.timeseries == other.timeseries</pre></div>
<div class="skip"><span class="num"><pre>494</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>495</pre></span><pre>  def __ne__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>496</pre></span><pre>    return not self.__eq__(other)</pre></div>
<div class="skip"><span class="num"><pre>497</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>498</pre></span><pre>class Metadata(object):</pre></div>
<div class="cov"><span class="num"><pre>499</pre></span><pre>  '''This class represents the metadata associated with an OpenMotorsport session.'''  </pre></div>
<div class="cov"><span class="num"><pre>500</pre></span><pre>  def __init__(self, **kwargs):</pre></div>
<div class="cov"><span class="num"><pre>501</pre></span><pre>    self.user = None</pre></div>
<div class="cov"><span class="num"><pre>502</pre></span><pre>    '''The name of the user.'''</pre></div>
<div class="skip"><span class="num"><pre>503</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>504</pre></span><pre>    self.venue = { </pre></div>
<div class="cov"><span class="num"><pre>505</pre></span><pre>      'name': None,</pre></div>
<div class="cov"><span class="num"><pre>506</pre></span><pre>      'configuration': None </pre></div>
<div class="cov"><span class="num"><pre>507</pre></span><pre>    }</pre></div>
<div class="cov"><span class="num"><pre>508</pre></span><pre>    '''A description for the venue. </pre></div>
<div class="skip"><span class="num"><pre>509</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>510</pre></span><pre>    Elements:</pre></div>
<div class="cov"><span class="num"><pre>511</pre></span><pre>      name</pre></div>
<div class="cov"><span class="num"><pre>512</pre></span><pre>        The title name of a venue (e.g. Silverstone).</pre></div>
<div class="cov"><span class="num"><pre>513</pre></span><pre>      configuration</pre></div>
<div class="cov"><span class="num"><pre>514</pre></span><pre>        The specific track layout (e.g. National or Grand Prix) [optional].</pre></div>
<div class="cov"><span class="num"><pre>515</pre></span><pre>    '''</pre></div>
<div class="skip"><span class="num"><pre>516</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>517</pre></span><pre>    self.vehicle = { </pre></div>
<div class="cov"><span class="num"><pre>518</pre></span><pre>      'name': None,</pre></div>
<div class="cov"><span class="num"><pre>519</pre></span><pre>      'year': None, </pre></div>
<div class="cov"><span class="num"><pre>520</pre></span><pre>      'comments': None, </pre></div>
<div class="cov"><span class="num"><pre>521</pre></span><pre>      'category': None </pre></div>
<div class="cov"><span class="num"><pre>522</pre></span><pre>    }</pre></div>
<div class="cov"><span class="num"><pre>523</pre></span><pre>    '''A description of the vehicle.</pre></div>
<div class="skip"><span class="num"><pre>524</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>525</pre></span><pre>    Elements:</pre></div>
<div class="cov"><span class="num"><pre>526</pre></span><pre>      name </pre></div>
<div class="cov"><span class="num"><pre>527</pre></span><pre>        A description of the vehicle (e.g. Van Diemen RF92). </pre></div>
<div class="cov"><span class="num"><pre>528</pre></span><pre>      year </pre></div>
<div class="cov"><span class="num"><pre>529</pre></span><pre>        e.g. 1992. [optional]</pre></div>
<div class="cov"><span class="num"><pre>530</pre></span><pre>      category</pre></div>
<div class="cov"><span class="num"><pre>531</pre></span><pre>        e.g. Formula Ford. [optional]</pre></div>
<div class="cov"><span class="num"><pre>532</pre></span><pre>      comments</pre></div>
<div class="cov"><span class="num"><pre>533</pre></span><pre>        A textual comment on the car. [optional]</pre></div>
<div class="cov"><span class="num"><pre>534</pre></span><pre>    ''' </pre></div>
<div class="skip"><span class="num"><pre>535</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>536</pre></span><pre>    self.date = datetime.datetime.now()</pre></div>
<div class="cov"><span class="num"><pre>537</pre></span><pre>    '''The date of the session.'''</pre></div>
<div class="skip"><span class="num"><pre>538</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>539</pre></span><pre>    self.comments = None</pre></div>
<div class="cov"><span class="num"><pre>540</pre></span><pre>    '''A textual comment on this session. [optional]'''</pre></div>
<div class="skip"><span class="num"><pre>541</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>542</pre></span><pre>    self.datasource = None</pre></div>
<div class="cov"><span class="num"><pre>543</pre></span><pre>    '''A description of the recording datasource (e.g. Pi System I). [optional]'''</pre></div>
<div class="skip"><span class="num"><pre>544</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>545</pre></span><pre>    self.__dict__.update(**kwargs)</pre></div>
<div class="skip"><span class="num"><pre>546</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>547</pre></span><pre>  def __repr__(self):</pre></div>
<div class="cov"><span class="num"><pre>548</pre></span><pre>    return '%s at %s (%s)' % (self.user, self.venue['name'], self.date)</pre></div>
<div class="skip"><span class="num"><pre>549</pre></span><pre>      </pre></div>
<div class="cov"><span class="num"><pre>550</pre></span><pre>  def __eq__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>551</pre></span><pre>    return other and \</pre></div>
<div class="cov"><span class="num"><pre>552</pre></span><pre>      self.user == other.user and \</pre></div>
<div class="cov"><span class="num"><pre>553</pre></span><pre>      self.venue == other.venue and \</pre></div>
<div class="cov"><span class="num"><pre>554</pre></span><pre>      self.vehicle == other.vehicle and \</pre></div>
<div class="cov"><span class="num"><pre>555</pre></span><pre>      self.date == other.date and \</pre></div>
<div class="cov"><span class="num"><pre>556</pre></span><pre>      self.comments == other.comments</pre></div>
<div class="skip"><span class="num"><pre>557</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>558</pre></span><pre>  def __ne__(self, other):</pre></div>
<div class="cov"><span class="num"><pre>559</pre></span><pre>    return not self.__eq__(other)</pre></div>
<div class="skip"><span class="num"><pre>560</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>561</pre></span><pre># /----------------------------------------------------------------------/</pre></div>
<div class="skip"><span class="num"><pre>562</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>563</pre></span><pre>class LazyVariableTimeSeries(VariableTimeSeries):</pre></div>
<div class="cov"><span class="num"><pre>564</pre></span><pre>  '''</pre></div>
<div class="cov"><span class="num"><pre>565</pre></span><pre>  A subclass of time.VariableTimeSeries that provides lazy initialisation of</pre></div>
<div class="cov"><span class="num"><pre>566</pre></span><pre>  data and times.</pre></div>
<div class="cov"><span class="num"><pre>567</pre></span><pre>  '''</pre></div>
<div class="cov"><span class="num"><pre>568</pre></span><pre>  def __init__(self, parent, channel_id):</pre></div>
<div class="cov"><span class="num"><pre>569</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre>570</pre></span><pre>    Construct a new instance of LazyVariableTimeSeries.</pre></div>
<div class="skip"><span class="num"><pre>571</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>572</pre></span><pre>    Arguments:</pre></div>
<div class="cov"><span class="num"><pre>573</pre></span><pre>      parent</pre></div>
<div class="cov"><span class="num"><pre>574</pre></span><pre>        The parent instance of openmotorsport.Session.</pre></div>
<div class="cov"><span class="num"><pre>575</pre></span><pre>      channel_id</pre></div>
<div class="cov"><span class="num"><pre>576</pre></span><pre>        The identifier of the channel this timeseries represents.</pre></div>
<div class="cov"><span class="num"><pre>577</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre>578</pre></span><pre>    self._parent = parent</pre></div>
<div class="cov"><span class="num"><pre>579</pre></span><pre>    self._channel_id = channel_id</pre></div>
<div class="cov"><span class="num"><pre>580</pre></span><pre>    self._loaded_data = False</pre></div>
<div class="cov"><span class="num"><pre>581</pre></span><pre>    self._loaded_times = False</pre></div>
<div class="cov"><span class="num"><pre>582</pre></span><pre>    VariableTimeSeries.__init__(self)    </pre></div>
<div class="skip"><span class="num"><pre>583</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>584</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>585</pre></span><pre>  def data(self):</pre></div>
<div class="cov"><span class="num"><pre>586</pre></span><pre>    if not self._loaded_data:</pre></div>
<div class="cov"><span class="num"><pre>587</pre></span><pre>      self._data = self._parent._read_channel_data(self._channel_id)</pre></div>
<div class="cov"><span class="num"><pre>588</pre></span><pre>      self._loaded_data = True</pre></div>
<div class="cov"><span class="num"><pre>589</pre></span><pre>    return self._data</pre></div>
<div class="skip"><span class="num"><pre>590</pre></span><pre>    </pre></div>
<div class="cov"><span class="num"><pre>591</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>592</pre></span><pre>  def times(self):</pre></div>
<div class="cov"><span class="num"><pre>593</pre></span><pre>    if not self._loaded_times:</pre></div>
<div class="cov"><span class="num"><pre>594</pre></span><pre>      self._times = self._parent._read_channel_times(self._channel_id)</pre></div>
<div class="cov"><span class="num"><pre>595</pre></span><pre>      self._loaded_times = True</pre></div>
<div class="cov"><span class="num"><pre>596</pre></span><pre>    return self._times</pre></div>
<div class="skip"><span class="num"><pre>597</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>598</pre></span><pre>class LazyUniformTimeSeries(UniformTimeSeries):</pre></div>
<div class="cov"><span class="num"><pre>599</pre></span><pre>  '''</pre></div>
<div class="cov"><span class="num"><pre>600</pre></span><pre>  A subclass of time.UniformTimeSeries that provides lazy initialisation of data.</pre></div>
<div class="cov"><span class="num"><pre>601</pre></span><pre>  '''</pre></div>
<div class="cov"><span class="num"><pre>602</pre></span><pre>  def __init__(self, frequency, parent, channel_id):</pre></div>
<div class="cov"><span class="num"><pre>603</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre>604</pre></span><pre>    Construct a new instance of LazyUniformTimeSeries.</pre></div>
<div class="skip"><span class="num"><pre>605</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>606</pre></span><pre>    Arguments:</pre></div>
<div class="cov"><span class="num"><pre>607</pre></span><pre>      frequency</pre></div>
<div class="cov"><span class="num"><pre>608</pre></span><pre>        The sample frequency of this channel, an instance of time.Frequency.</pre></div>
<div class="cov"><span class="num"><pre>609</pre></span><pre>      parent</pre></div>
<div class="cov"><span class="num"><pre>610</pre></span><pre>        The parent instance of openmotorsport.Session.</pre></div>
<div class="cov"><span class="num"><pre>611</pre></span><pre>      channel_id</pre></div>
<div class="cov"><span class="num"><pre>612</pre></span><pre>        The identifier of the channel this timeseries represents.</pre></div>
<div class="cov"><span class="num"><pre>613</pre></span><pre>    '''</pre></div>
<div class="cov"><span class="num"><pre>614</pre></span><pre>    self._parent = parent</pre></div>
<div class="cov"><span class="num"><pre>615</pre></span><pre>    self._channel_id = channel_id</pre></div>
<div class="cov"><span class="num"><pre>616</pre></span><pre>    self._loaded_data = False</pre></div>
<div class="cov"><span class="num"><pre>617</pre></span><pre>    UniformTimeSeries.__init__(self, frequency=frequency)</pre></div>
<div class="skip"><span class="num"><pre>618</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>619</pre></span><pre>  @property</pre></div>
<div class="cov"><span class="num"><pre>620</pre></span><pre>  def data(self):</pre></div>
<div class="cov"><span class="num"><pre>621</pre></span><pre>    if not self._loaded_data:</pre></div>
<div class="cov"><span class="num"><pre>622</pre></span><pre>      self._data = self._parent._read_channel_data(self._channel_id)</pre></div>
<div class="cov"><span class="num"><pre>623</pre></span><pre>      self._loaded_data = True</pre></div>
<div class="cov"><span class="num"><pre>624</pre></span><pre>    return self._data</pre></div>
<div class="skip"><span class="num"><pre>625</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>626</pre></span><pre># /----------------------------------------------------------------------/</pre></div>
<div class="skip"><span class="num"><pre>627</pre></span><pre></pre></div>
<div class="skip"><span class="num"><pre>628</pre></span><pre># NB: Upper Camel Case for consistency with ElementTree.                   </pre></div>
<div class="cov"><span class="num"><pre>629</pre></span><pre>def SubElementFromDict(parent, dict, key):</pre></div>
<div class="cov"><span class="num"><pre>630</pre></span><pre>  '''Creates an ElementTree text element from a given dict and key. If the </pre></div>
<div class="cov"><span class="num"><pre>631</pre></span><pre>  key does not exist in the dict, an Exception is raised.'''</pre></div>
<div class="cov"><span class="num"><pre>632</pre></span><pre>  if dict[key] is None: raise Exception('Missing value for %s' % key)</pre></div>
<div class="cov"><span class="num"><pre>633</pre></span><pre>  ET.SubElement(parent, key).text = dict[key]</pre></div>
<div class="skip"><span class="num"><pre>634</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>635</pre></span><pre>def SubElementFromDictConditional(parent, dict, key):</pre></div>
<div class="cov"><span class="num"><pre>636</pre></span><pre>  '''Creates an ElementTree text elelemnt from a given dict and key only if</pre></div>
<div class="cov"><span class="num"><pre>637</pre></span><pre>  the key exist and its value is not None.'''</pre></div>
<div class="cov"><span class="num"><pre>638</pre></span><pre>  if dict.has_key(key) and dict[key] is not None:</pre></div>
<div class="cov"><span class="num"><pre>639</pre></span><pre>    ET.SubElement(parent, key).text = dict[key]</pre></div>
<div class="skip"><span class="num"><pre>640</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>641</pre></span><pre>def to_iso8601_date(date):</pre></div>
<div class="cov"><span class="num"><pre>642</pre></span><pre>  '''Gets an ISO-8601 string for a given date.'''</pre></div>
<div class="cov"><span class="num"><pre>643</pre></span><pre>  return date.strftime(&quot;%Y-%m-%dT%H:%M:%S&quot;)</pre></div>
<div class="skip"><span class="num"><pre>644</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>645</pre></span><pre>def from_iso8601_date(string):</pre></div>
<div class="cov"><span class="num"><pre>646</pre></span><pre>  '''Gets a date from an ISO-8601 string.'''</pre></div>
<div class="cov"><span class="num"><pre>647</pre></span><pre>  return datetime.datetime.now().strptime(string, &quot;%Y-%m-%dT%H:%M:%S&quot;)</pre></div>
<div class="skip"><span class="num"><pre>648</pre></span><pre>  </pre></div>
<div class="cov"><span class="num"><pre>649</pre></span><pre>def ns(string):</pre></div>
<div class="cov"><span class="num"><pre>650</pre></span><pre>  '''Format an XPath with the default namespace.'''</pre></div>
<div class="cov"><span class="num"><pre>651</pre></span><pre>  return '{%s}%s' % (BASE_NS, string)</pre></div>
<div class="skip"><span class="num"><pre>652</pre></span><pre></pre></div>
<div class="cov"><span class="num"><pre>653</pre></span><pre>BASE_NS = 'http://66laps.org/ns/openmotorsport-1.0'</pre></div>
<div class="cov"><span class="num"><pre>654</pre></span><pre>'''The default namespace of an OpenMotorsport document.'''</pre></div>
</div>
</body>
</html>
